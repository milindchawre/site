
<!doctype html>

<html xmlns="http://www.w3.org/1999/xhtml"  lang="en">

    <head>

        
        <meta charset="UTF-8" />

        
        <meta name="viewport" content="width=device-width, initial-scale=1"/>

                
        <title> 
             K3s Upgrade: A Simplified Guide  
        </title>
        
        
            <link href="https://milindchawre.github.io/site/index.xml" rel="alternate" type="application/rss+xml" title="Milind&#39;s Blog" />
        

        
        <link rel="stylesheet" href="/site/css/style.css"/>

        
        
            <link rel='stylesheet' href='https://milindchawre.github.io/site/css/custom.css'>
        
        
    </head>

    <body>



<section class="section">
  <div class="container">
    <nav id="nav-main" class="nav">
      <div id="nav-name" class="nav-left">
        <a id="nav-anchor" class="nav-item" href="https://milindchawre.github.io/site/">
          <h1 id="nav-heading" class="title is-4">Milind&#39;s Blog</h1>
        </a>
      </div>
      <div class="nav-right">
        
        
        <nav id="nav-items" class="nav-item level is-mobile">
          <a class="level-item" aria-label="about" href='/site/about'
           rel='noopener'>
            <span class="icon">
              <i class>

<svg viewbox='0 0 24 24' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' aria-hidden='true'>
    
    <circle cx="12" cy="12" r="10"></circle><line x1="12" y1="16" x2="12" y2="12"></line><line x1="12" y1="8" x2="12" y2="8"></line>
    
  </svg>
</i>
            </span>
          </a>
          <a class="level-item" aria-label="resume" href='https://milindchawre.github.io'
           target='_blank'  rel='noopener'>
            <span class="icon">
              <i class>

<svg viewbox='0 0 24 24' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' aria-hidden='true'>
    
    <path d="M22.125 2.25H1.875A1.127 1.127 0 0 0 .75 3.375v17.25a1.127 1.127 0 0 0 1.125 1.125H6v-2.757c0-.351.192-.656.477-.817l.005-.002l4.311-2.396l-1.419-3.546V9.376a2.625 2.625 0 1 1 5.25 0v2.856l-1.419 3.546l4.312 2.396c.29.163.482.469.482.819v2.757h4.125a1.127 1.127 0 0 0 1.125-1.125V3.375a1.127 1.127 0 0 0-1.125-1.125zm-.375 18H19.5v-1.257c0-.911-.5-1.706-1.241-2.124l-.012-.006l-3.157-1.755l1.035-2.588V9.376a4.125 4.125 0 0 0-8.25 0v3.144l1.035 2.588l-3.157 1.755a2.441 2.441 0 0 0-1.253 2.13v1.257H2.25V3.75h19.5z" fill="black"/>
    
  </svg>
</i>
            </span>
          </a>
          <a class="level-item" aria-label="email" href='mailto:milindchawre@outlook.com'
           target='_blank'  rel='noopener'>
            <span class="icon">
              <i class>

<svg viewbox='0 0 24 24' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' aria-hidden='true'>
    
    <path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"/>
    <polyline points="22,6 12,13 2,6"/>
    
  </svg>
</i>
            </span>
          </a>
          <a class="level-item" aria-label="github" href='https://github.com/milindchawre'
           target='_blank'  rel='noopener'>
            <span class="icon">
              <i class>

<svg viewbox='0 0 24 24' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' aria-hidden='true'>
    
    <path d="M9 19c-5 1.5-5-2.5-7-3m14 6v-3.87a3.37 3.37 0 0 0-.94-2.61c3.14-.35 6.44-1.54 6.44-7A5.44 5.44 0 0 0 20 4.77 5.07 5.07 0 0 0 19.91 1S18.73.65 16 2.48a13.38 13.38 0 0 0-7 0C6.27.65 5.09 1 5.09 1A5.07 5.07 0 0 0 5 4.77a5.44 5.44 0 0 0-1.5 3.78c0 5.42 3.3 6.61 6.44 7A3.37 3.37 0 0 0 9 18.13V22"/>
    
  </svg>
</i>
            </span>
          </a>
          <a class="level-item" aria-label="linkedin" href='https://linkedin.com/in/milind-chawre'
           target='_blank'  rel='noopener'>
            <span class="icon">
              <i class>

<svg viewbox='0 0 24 24' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' aria-hidden='true'>
    
    <path stroke-width="1.8" d="m5.839218,4.101561c0,1.211972 -0.974141,2.194011 -2.176459,2.194011s-2.176459,-0.982039 -2.176459,-2.194011c0,-1.211094 0.974141,-2.194011 2.176459,-2.194011s2.176459,0.982917 2.176459,2.194011zm0.017552,3.94922l-4.388022,0l0,14.04167l4.388022,0l0,-14.04167zm7.005038,0l-4.359939,0l0,14.04167l4.360816,0l0,-7.370999c0,-4.098413 5.291077,-4.433657 5.291077,0l0,7.370999l4.377491,0l0,-8.89101c0,-6.915523 -7.829986,-6.66365 -9.669445,-3.259423l0,-1.891237z"/>
    
  </svg>
</i>
            </span>
          </a>
          <a class="level-item" aria-label="stackoverflow" href='https://stackoverflow.com/users/6790948/mchawre?tab=profile'
           target='_blank'  rel='noopener'>
            <span class="icon">
              <i class>

<svg viewbox='0 0 24 24' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' aria-hidden='true'>
    
    <path d="M18.986 21.865v-6.404h2.134V24H1.844v-8.539h2.13v6.404h15.012zM6.111 19.731H16.85v-2.137H6.111v2.137zm.259-4.852l10.48 2.189l.451-2.07l-10.478-2.187l-.453 2.068zm1.359-5.056l9.705 4.53l.903-1.95l-9.706-4.53l-.902 1.936v.014zm2.715-4.785l8.217 6.855l1.359-1.62l-8.216-6.853l-1.35 1.617l-.01.001zM15.751 0l-1.746 1.294l6.405 8.604l1.746-1.294L15.749 0h.002z" fill="white"/>
    
  </svg>
</i>
            </span>
          </a>
          <a class="level-item" aria-label="twitter" href='https://twitter.com/@milindchawre'
           target='_blank'  rel='noopener'>
            <span class="icon">
              <i class>

<svg viewbox='0 0 24 24' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' aria-hidden='true'>
    
    <path d="M23 3a10.9 10.9 0 0 1-3.14 1.53 4.48 4.48 0 0 0-7.86 3v1A10.66 10.66 0 0 1 3 4s-4 9 5 13a11.64 11.64 0 0 1-7 2c9 5 20 0 20-11.5a4.5 4.5 0 0 0-.08-.83A7.72 7.72 0 0 0 23 3z"/>
    
  </svg>
</i>
            </span>
          </a>
          <a class="level-item" aria-label="facebook" href='https://facebook.com/milind.chawre'
           target='_blank'  rel='noopener'>
            <span class="icon">
              <i class>

<svg viewbox='0 0 24 24' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' aria-hidden='true'>
    
    <path d="M18 2h-3a5 5 0 0 0-5 5v3H7v4h3v8h4v-8h3l1-4h-4V7a1 1 0 0 1 1-1h3z"/>
    
  </svg>
</i>
            </span>
          </a>
          <a class="level-item" aria-label="rss" href='/site/index.xml'
           target='_blank'  rel='noopener'>
            <span class="icon">
              <i class>

<svg viewbox='0 0 24 24' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' aria-hidden='true'>
    
    <path d="M4 11a9 9 0 0 1 9 9"></path><path d="M4 4a16 16 0 0 1 16 16"></path><circle cx="5" cy="19" r="1"></circle>
    
  </svg>
</i>
            </span>
          </a></nav>
        
      
      </div>
    </nav>

    <nav class="nav">
      

      
    </nav>

  </div>
</section>

<section class="section">
    
    <div class="container">
    
        
            
<div class="subtitle tags is-6 is-pulled-right">
    
        
<a class="subtitle is-6" href="/tags/kubernetes/">#kubernetes</a>



  
  | <a class="subtitle is-6" href="/tags/k3s/">#k3s</a>
  


    
</div>



<h2 class="subtitle is-6">
    
    
        July 2, 2020 | 23:03
    
</h2>



<h1 class="title">K3s Upgrade: A Simplified Guide</h1>

<div class="content">

    
    <p><img src="https://github.com/milindchawre/civo-k8s/raw/master/blog/k3s-upgrade/images/k3s-header-image.png" alt="k3s-header-image"></p>
<p><em>This blog was originally featured as a <a href="https://kubezilla.com/k3s-upgrade-a-simplified-guide/">guide</a> in kubezilla community.</em></p>
<h4 id="introduction">Introduction</h4>
<p><a href="https://k3s.io/">K3s</a> is a lightweight Kubernetes distribution which runs with a very small footprint and is a <a href="https://rancher.com/blog/2019/why-k3s-is-the-future-of-k8s-at-the-edge/">suitable candidate</a> for <a href="https://en.wikipedia.org/wiki/Edge_computing">edge computing</a>. K3s is capable of nearly everything k8s can do. It is just a more lightweight version. It is the ONLY certified Kubernetes distribution built for IoT &amp; Edge computing. It is a highly available, certified Kubernetes distribution designed for production workloads in unattended, resource-constrained, remote locations or inside IoT appliances. It is packaged as a single &lt;40MB binary that reduces the dependencies and steps needed to install, run and auto-update a production Kubernetes cluster. K3s is optimized for ARM. Both ARM64 and ARMv7 are supported with binaries and multi-arch images available for both. K3s works great from something as small as a Raspberry Pi to an AWS a1.4xlarge 32GiB server.</p>
<p>If you are running some old version of <a href="https://k3s.io/">k3s</a> and want to upgrade to some new stable version, then this is the guide for you. In this blog, we are going to discuss the <a href="https://rancher.com/docs/k3s/latest/en/upgrades/automated/">automated way</a> for k3s upgrade compared to the <a href="https://rancher.com/docs/k3s/latest/en/upgrades/basic/">manual way</a>.</p>
<p><img src="https://github.com/milindchawre/civo-k8s/raw/master/blog/k3s-upgrade/images/k3s-upgrade.png" alt="k3s-upgrade"></p>
<h4 id="steps-for-k3s-upgradation">Steps for k3s upgradation</h4>
<h5 id="_pre-requisite_"><strong><em>Pre-requisite</em></strong></h5>
<ul>
<li>k3s cluster (which you want to upgrade)</li>
<li>kubectl (to communicate with k3s cluster)</li>
<li>KUBECONFIG env pointing to your kubernetes config file</li>
</ul>
<h5 id="_connect-to-the-cluster_"><strong><em>Connect to the cluster</em></strong></h5>
<p>First connect to your k3s cluster and list down all the k8s nodes.</p>
<pre tabindex="0"><code># Ensure KUBECONFIG env is pointing to your kubernetes config file
$ kubtctl get nodes
NAME               STATUS   ROLES    AGE    VERSION
kube-node-c982     Ready    &lt;none&gt;   130m   v1.16.3-k3s1
kube-master-ce86   Ready    master   131m   v1.16.3-k3s1
kube-node-4d85     Ready    &lt;none&gt;   130m   v1.16.3-k3s1
</code></pre><p>As you can see all the nodes are running <code>v1.16.3-k3s1</code> of k3s.</p>
<h5 id="_install-the-system-upgrade-controller_"><strong><em>Install the system-upgrade-controller</em></strong></h5>
<p>The k3s cluster upgradation is handled by a controller named <a href="https://github.com/rancher/system-upgrade-controller">system-upgrade-controller</a> which leverages a <a href="https://kubernetes.io/docs/concepts/extend-kubernetes/api-extension/custom-resources/#custom-resources">custom resource definition (CRD)</a>, the <code>plan</code>, and a <a href="https://kubernetes.io/docs/concepts/architecture/controller/">controller</a> that schedules upgrades based on the configured plans. This <code>system-upgrade-controller</code> need to be installed as a deployment in your k3s cluster. To install it run following command:</p>
<pre tabindex="0"><code>kubectl apply -f https://raw.githubusercontent.com/rancher/system-upgrade-controller/master/manifests/system-upgrade-controller.yaml
</code></pre><p>You should see the upgrade controller starting in <code>system-upgrade</code> namespace as shown below.</p>
<pre tabindex="0"><code>$ kubectl get all -n system-upgrade
NAME                                             READY   STATUS    RESTARTS   AGE
pod/system-upgrade-controller-7fff98589f-8cjsv   1/1     Running   0          23s

NAME                                        READY   UP-TO-DATE   AVAILABLE   AGE
deployment.apps/system-upgrade-controller   1/1     1            1           24s

NAME                                                   DESIRED   CURRENT   READY   AGE
replicaset.apps/system-upgrade-controller-7fff98589f   1         1         1       24s
</code></pre><h5 id="_configure-plans_"><strong><em>Configure Plans</em></strong></h5>
<p>The Plan defines upgrade policies and requirements. The controller schedules upgrades by monitoring these plans and selecting nodes to run upgrade <a href="https://kubernetes.io/docs/concepts/workloads/controllers/jobs-run-to-completion/">jobs</a> on it. So lets create two plans: one for server (master) nodes and other one for agent (worker) nodes. The following two example plans will upgrade your cluster to k3s <code>v1.18.4+k3s1</code>.</p>
<pre tabindex="0"><code># Server plan
apiVersion: upgrade.cattle.io/v1
kind: Plan
metadata:
  name: server-plan
  namespace: system-upgrade
spec:
  concurrency: 1
  cordon: true
  nodeSelector:
    matchExpressions:
    - key: k3s-master-upgrade
      operator: In
      values:
      - &#34;true&#34;
  serviceAccountName: system-upgrade
  upgrade:
    image: rancher/k3s-upgrade
  version: v1.18.4+k3s1
---
# Agent plan
apiVersion: upgrade.cattle.io/v1
kind: Plan
metadata:
  name: agent-plan
  namespace: system-upgrade
spec:
  concurrency: 1
  cordon: true
  nodeSelector:
    matchExpressions:
    - key: k3s-worker-upgrade
      operator: In
      values:
      - &#34;true&#34;
  prepare:
    args:
    - prepare
    - server-plan
    image: rancher/k3s-upgrade
  serviceAccountName: system-upgrade
  upgrade:
    image: rancher/k3s-upgrade
  version: v1.18.4+k3s1
</code></pre><p>There are few important fields to notice in above plans.</p>
<ul>
<li>There are two plans: <code>server-plan and agent-plan</code> to define upgrade policies for both types of nodes in k3s.</li>
<li>The <code>concurrency</code> field: that defines how many nodes can be upgraded at the same time.</li>
<li>The <code>nodeSelector</code> field is used to specify nodes to which a particular plan will be applied. In our case nodes with label <code>k3s-master-upgrade=true</code> targets master nodes while label <code>k3s-worker-upgrade=true</code> targets worker nodes of k3s.</li>
<li>The <code>prepare</code> field in the agent-plan will cause upgrade jobs for that plan to wait for the server-plan to complete before they execute. So as to ensure that all master nodes are upgraded prior to the worker nodes.</li>
<li>The <code>image: rancher/k3s-upgrade</code> field specify the <a href="https://github.com/rancher/k3s-upgrade">k3s-upgrade</a> image which is responsible of upgrading k3s version via the <a href="https://github.com/rancher/system-upgrade-controller">System Upgrade Controller</a>, it does so by replacing the k3s binary with the new version and killing the old k3s process allowing the supervisor to restart k3s with the new version.</li>
<li>The <code>version</code> field specify the version of k3s to which we need to upgrade. In our case, it is set to version <code>v1.18.4+k3s1</code>. Alternatively, you can skip the version field altogether by using another field <code>channel: https://update.k3s.io/v1-release/channels/stable</code> using which we can ask plan to pull latest stable version of k3s.</li>
</ul>
<h5 id="_assign-labels-to-nodes_"><strong><em>Assign labels to nodes</em></strong></h5>
<p>Label the nodes that you want to upgrade with the right label:</p>
<pre tabindex="0"><code># For master nodes
kubectl label node &lt;node-name&gt; k3s-master-upgrade=true
                   OR
# For worker nodes
kubectl label node &lt;node-name&gt; k3s-worker-upgrade=true
</code></pre><p>In our case its:</p>
<pre tabindex="0"><code>$ kubectl label node kube-master-ce86 k3s-master-upgrade=true
node/kube-master-ce86 labeled
$ kubectl label node kube-node-c982  k3s-worker-upgrade=true
node/kube-node-c982 labeled
$ kubectl label node kube-node-4d85 k3s-worker-upgrade=true
node/kube-node-4d85 labeled
</code></pre><h5 id="_apply-plans_"><strong><em>Apply plans</em></strong></h5>
<p>Now apply the plans defined above using kubectl apply command.</p>
<pre tabindex="0"><code>$ kubectl apply -f plans.yaml
plan.upgrade.cattle.io/server-plan created
plan.upgrade.cattle.io/agent-plan created
$ kubectl get plans -n system-upgrade
NAME          AGE
server-plan   14s
agent-plan    14s
</code></pre><p>As soon as you apply the plan, the controller will detect it and will begin the upgrade process. On the other hand, if you update any existing plans the controller will re-evaluate the plan and will determine if another upgrade is needed.</p>
<h5 id="_verify-the-upgrade_"><strong><em>Verify the upgrade</em></strong></h5>
<p>You can monitor the progress of an upgrade by viewing the plan and jobs via kubectl:</p>
<pre tabindex="0"><code>kubectl -n system-upgrade get plans -o yaml
kubectl -n system-upgrade get jobs -o yaml
</code></pre><p>Once the upgrade is done. Verify the new installed version on all the nodes using kubectl:</p>
<pre tabindex="0"><code>$ kubectl get nodes
NAME               STATUS   ROLES    AGE    VERSION
kube-master-ce86   Ready    master   147m   v1.18.4+k3s1
kube-node-c982     Ready    &lt;none&gt;   147m   v1.18.4+k3s1
kube-node-4d85     Ready    &lt;none&gt;   147m   v1.18.4+k3s1
</code></pre><h5 id="_conclusion_"><strong><em>Conclusion</em></strong></h5>
<p>The <a href="https://github.com/rancher/k3s-upgrade">k3s-upgrade</a> and <a href="https://github.com/rancher/system-upgrade-controller">system-upgrade-controller</a> makes the overall k3s upgrade process easier compared to the <a href="https://rancher.com/docs/k3s/latest/en/upgrades/basic/">manual upgrade method</a> with a minimal downtime as the k3s upgradation proceeds in rolling deployment fashion.</p>


    
    
        <div class="related">


<h3>Similar articles</h3>

<ul>
	
	<li><a href="/site/blog/develop-and-test-your-code-directly-in-kubernetes-using-okteto/">Develop and Test Your Code Directly in Kubernetes Using Okteto</a></li>
	
	<li><a href="/site/blog/fairwinds-goldilocks-kubernetes-resource-recommendation-tool/">Fairwinds Goldilocks : Kubernetes Resource Recommendation Tool</a></li>
	
	<li><a href="/site/blog/setting-up-polaris-on-kubernetes/">Setting Up Polaris on Kubernetes</a></li>
	
</ul>


</div>
    

</div>


        

    </div>

</section>



<section class="section">
  <div class="container has-text-centered">
    <p>© 2020</p>
    
      <p>Powered by <a href="https://gohugo.io/">Hugo</a> &amp; <a href="https://github.com/pavel-pi/kiss-em">Kiss'Em</a>.</p>
    
  </div>
</section>

</body>
</html>

